{% extends "base.html" %}

{% block title %}Procesando Documentos{% endblock %}

{% block content %}
<div class="processing-container">
    <div class="progress-card">
        <div class="progress-header">
            <h2>üîÑ Procesando Documentos</h2>
            <p class="lead">Tu an√°lisis est√° en curso. Por favor, espera mientras procesamos tus documentos.</p>
        </div>
        
        <div class="progress-section">
            <div class="progress-label">
                <span id="progress-message">Iniciando procesamiento...</span>
                <span class="progress-percent" id="progress-percent">0%</span>
            </div>
            
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="progress-bar"></div>
            </div>
        </div>
        
        <div class="status-section">
            <div class="status-indicator" id="status-indicator"></div>
            <div class="status-text" id="status-text">Estado: Iniciando...</div>
        </div>
        
        <div class="action-buttons">
            <button id="cancel-btn" class="btn btn-secondary">
                <span class="btn-icon">‚èπÔ∏è</span>
                Cancelar
            </button>
            <button id="refresh-btn" class="btn btn-primary" disabled>
                <span class="btn-icon">üîÑ</span>
                Actualizando...
            </button>
        </div>
        
        <div class="tips-section">
            <h4>üí° Consejos mientras esperas:</h4>
            <ul>
                <li>Tiempo estimado: 1-3 minutos por cada 20 preguntas</li>
                <li>PDFs escaneados (OCR) toman ~2 segundos por p√°gina</li>
                <li>Mant√©n esta pesta√±a abierta para ver el progreso en tiempo real</li>
                <li>No cierres el navegador hasta que finalice el procesamiento</li>
            </ul>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/progress.js') }}"></script>
<script>
    // Inicializar seguimiento de progreso
    document.addEventListener('DOMContentLoaded', function() {
        const taskId = '{{ task_id }}';
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');
        const progressMessage = document.getElementById('progress-message');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const refreshBtn = document.getElementById('refresh-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        
        let pollInterval;
        let isCancelled = false;
        
        function updateUI(task) {
            // Actualizar barra de progreso
            const percent = Math.min(100, Math.max(0, task.progress || 0));
            progressBar.style.width = `${percent}%`;
            progressPercent.textContent = `${Math.round(percent)}%`;
            progressMessage.textContent = task.message || 'Procesando...';
            
            // Actualizar estado
            statusText.textContent = `Estado: ${task.status.replace('_', ' ')}`;
            
            // Actualizar indicador de estado
            statusIndicator.className = 'status-indicator';
            if (task.status === 'completado') {
                statusIndicator.classList.add('status-success');
                statusText.textContent = '‚úÖ ¬°Completado!';
                clearInterval(pollInterval);
                refreshBtn.innerHTML = '<span class="btn-icon">‚úÖ</span> Ir a Resultados';
                refreshBtn.disabled = false;
                refreshBtn.onclick = () => window.location.href = `/resultados/${taskId}`;
            } else if (task.status === 'error') {
                statusIndicator.classList.add('status-error');
                statusText.textContent = `‚ùå Error: ${task.message}`;
                clearInterval(pollInterval);
                refreshBtn.innerHTML = '<span class="btn-icon">‚Ü©Ô∏è</span> Volver al Inicio';
                refreshBtn.disabled = false;
                refreshBtn.onclick = () => window.location.href = '/';
            } else {
                statusIndicator.classList.add('status-processing');
            }
        }
        
        function pollStatus() {
            fetch(`/status/${taskId}`)
                .then(response => response.json())
                .then(task => {
                    if (isCancelled) return;
                    
                    updateUI(task);
                    
                    // Si completado o error, detener polling
                    if (task.status === 'completado' || task.status === 'error') {
                        clearInterval(pollInterval);
                    }
                })
                .catch(error => {
                    console.error('Error polling status:', error);
                    if (!isCancelled) {
                        statusText.textContent = '‚ö†Ô∏è Problema de conexi√≥n. Reintentando...';
                    }
                });
        }
        
        // Iniciar polling cada 1.5 segundos
        pollInterval = setInterval(pollStatus, 1500);
        pollStatus(); // Primera actualizaci√≥n inmediata
        
        // Manejar cancelaci√≥n
        cancelBtn.addEventListener('click', () => {
            isCancelled = true;
            clearInterval(pollInterval);
            statusText.textContent = '‚èπÔ∏è Procesamiento cancelado';
            statusIndicator.className = 'status-indicator status-cancelled';
            refreshBtn.innerHTML = '<span class="btn-icon">‚Ü©Ô∏è</span> Volver al Inicio';
            refreshBtn.disabled = false;
            refreshBtn.onclick = () => window.location.href = '/';
        });
    });
</script>
{% endblock %}